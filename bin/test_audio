#!/bin/bash

echo "ğŸ™ï¸ Testing Audio System for Ruby Voice Agent"
echo "============================================"

# Test recording
echo "1ï¸âƒ£  Testing audio recording with sox..."
if command -v sox &> /dev/null; then
    echo "âœ… Sox is installed"
    echo "ğŸ¤ Recording 3 seconds of audio (speak now)..."
    sox -d test_recording.wav trim 0 3
    if [ -f test_recording.wav ]; then
        echo "âœ… Recording successful"
        echo "ğŸ”Š Playing back recording..."
        play test_recording.wav
        rm test_recording.wav
    else
        echo "âŒ Recording failed"
    fi
else
    echo "âŒ Sox not found. Please install with: brew install sox"
fi

echo ""

# Test TTS
echo "2ï¸âƒ£  Testing text-to-speech with espeak..."
if command -v espeak &> /dev/null; then
    echo "âœ… Espeak is installed"
    echo "ğŸ”Š Testing TTS..."
    espeak "Hello, this is a test of the Ruby voice agent text to speech system"
else
    echo "âš ï¸  Espeak not found. Trying macOS say command..."
    if command -v say &> /dev/null; then
        echo "âœ… Using macOS say command"
        say "Hello, this is a test of the Ruby voice agent text to speech system"
    else
        echo "âŒ No TTS system found"
    fi
fi

echo ""

# Test Whisper
echo "3ï¸âƒ£  Testing Whisper installation..."
if command -v ~/.local/bin/whisper &> /dev/null; then
    echo "âœ… Whisper is installed"
else
    echo "âŒ Whisper not found at ~/.local/bin/whisper"
    echo "   Try running: pipx install openai-whisper"
fi

echo ""

# Test Ollama
echo "4ï¸âƒ£  Testing Ollama connection..."
if curl -s http://localhost:11434/api/tags > /dev/null; then
    echo "âœ… Ollama is running"
    echo "ğŸ“‹ Available models:"
    curl -s http://localhost:11434/api/tags | grep -o '"name":"[^"]*"' | cut -d'"' -f4
else
    echo "âŒ Ollama is not running or not accessible"
    echo "   Try running: ollama serve"
fi

echo ""

# Test Python VAD
echo "5ï¸âƒ£  Testing Python VAD setup..."
if [ -f venv/bin/python ]; then
    echo "âœ… Python virtual environment found"
    if venv/bin/python -c "import webrtcvad" &> /dev/null; then
        echo "âœ… webrtcvad is installed"
    else
        echo "âŒ webrtcvad not found in virtual environment"
    fi
else
    echo "âŒ Python virtual environment not found"
fi

echo ""
echo "ğŸ Audio test complete!"
echo "If all tests passed, you're ready to run: ./bin/start_agent simple"